<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>MWC ‚Äî 2 —Ñ–æ—Ç–æ: —Ä–∞–∑–º–µ—Ç–∫–∞ + –∞–Ω–∞–ª–∏–∑ —Ä–æ—Å—Ç–∞</title>
<meta name="theme-color" content="#111">
<style>
  body{font-family:-apple-system,system-ui,Arial;margin:16px}
  h1{font-size:20px;margin:0 0 8px}
  .small{font-size:13px;color:#555;margin:6px 0}
  .card{border:1px solid #ddd;border-radius:12px;padding:12px;margin:10px 0}
  button{width:100%;padding:12px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;font-weight:800}
  button.secondary{background:#fff;color:#111}
  button:disabled{opacity:.45}
  input[type="file"]{width:100%;margin:8px 0}
  canvas{width:100%;border:1px solid #ddd;border-radius:12px;touch-action:none}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row > button{flex:1;min-width:150px}
  .kv{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:13px;color:#111;white-space:pre-wrap}
  .ok{color:#0a7;font-weight:800}
  .warn{color:#c90;font-weight:800}
  .bad{color:#c00;font-weight:800}
</style>
</head>

<body>
<h1>MWC ‚Äî 2 —Ñ–æ—Ç–æ (Day1/Day2): —Ä—É—á–Ω–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞ + –∞–≤—Ç–æ —Ä–æ—Å—Ç</h1>
<div class="small">
<b>–†–∞–∑–º–µ—Ç–∫–∞:</b> Tap –ø–æ –≥—Ä–∏–±—É = –º–µ—Ç–∫–∞ ‚Ä¢ Tap –ø–æ –º–µ—Ç–∫–µ = —É–¥–∞–ª–∏—Ç—å ‚Ä¢ Hold+Drag = –ø–µ—Ä–µ–¥–≤–∏–Ω—É—Ç—å.<br>
<b>–ê–Ω–∞–ª–∏–∑:</b> –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç ‚Äú—Ä–∞–∑–º–µ—Ä‚Äù –≥—Ä–∏–±–∞ –≤–æ–∫—Ä—É–≥ –º–µ—Ç–∫–∏ –Ω–∞ Day1 –∏ Day2 –∏ –Ω–∞ Day2 –∫—Ä–∞—Å–∏—Ç –∑–µ–ª—ë–Ω—ã–º —Ç–æ, —á—Ç–æ –≤—ã—Ä–æ—Å–ª–æ.
</div>

<div class="card">
  <b>–§–æ—Ç–æ</b>
  <div class="small">Day1</div>
  <input id="img1" type="file" accept="image/*">
  <div class="small">Day2</div>
  <input id="img2" type="file" accept="image/*">

  <div class="row">
    <button id="view1" class="secondary" disabled>–ü–æ–∫–∞–∑–∞—Ç—å Day1</button>
    <button id="view2" class="secondary" disabled>–ü–æ–∫–∞–∑–∞—Ç—å Day2</button>
  </div>

  <button id="analyze" disabled>–ê–Ω–∞–ª–∏–∑ —Ä–æ—Å—Ç–∞ (–ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å –∑–µ–ª—ë–Ω—ã–º –Ω–∞ Day2)</button>
  <div class="kv" id="status">–ó–∞–≥—Ä—É–∑–∏ 2 —Ñ–æ—Ç–æ.</div>
</div>

<div class="card">
  <b>–†–∞–∑–º–µ—Ç–∫–∞</b>
  <canvas id="cv"></canvas>
  <div class="small">üü° –º–µ—Ç–∫–∏ ‚Ä¢ üü¢ –≤—ã—Ä–æ—Å–ª–æ (–ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞ –Ω–∞ Day2) ‚Ä¢ üî¥ –Ω–µ—Ç –ø–∞—Ä—ã/–Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>

  <div class="row">
    <button id="undo" class="secondary" disabled>Undo</button>
    <button id="clear" class="secondary" disabled>–û—á–∏—Å—Ç–∏—Ç—å –º–µ—Ç–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è</button>
  </div>

  <div class="row">
    <button id="export" class="secondary" disabled>–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
    <button id="savepng" class="secondary" disabled>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å PNG</button>
  </div>
</div>

<script>
const img1Input = document.getElementById("img1");
const img2Input = document.getElementById("img2");
const view1Btn  = document.getElementById("view1");
const view2Btn  = document.getElementById("view2");
const analyzeBtn= document.getElementById("analyze");

const cv = document.getElementById("cv");
const ctx = cv.getContext("2d", { willReadFrequently:true });

const statusEl = document.getElementById("status");
const undoBtn = document.getElementById("undo");
const clearBtn = document.getElementById("clear");
const exportBtn = document.getElementById("export");
const savePngBtn = document.getElementById("savepng");

let img1=null, img2=null;
let marks1=[]; // {x,y}
let marks2=[]; // {x,y}
let history=[]; // stack {day, marks1, marks2, analysis}
let day=1; // 1 or 2

// analysis results (drawn when day=2)
let analysis = null;
/*
analysis = {
  pairs: [{i1,i2, r1, r2, grown, ok}],
  grownIdx2: Set([...]),
  unmatched2: Set([...]),
  meta: {maxDist, growPx, maxR}
}
*/

let dragging=false, dragIdx=-1, pressTimer=null;

function setStatus(text, cls=""){
  statusEl.className = "kv " + cls;
  statusEl.textContent = text;
}
function ready(){ return !!(img1 && img2); }
function curMarks(){ return day===1 ? marks1 : marks2; }

function pushHistory(){
  history.push({
    day,
    marks1: JSON.stringify(marks1),
    marks2: JSON.stringify(marks2),
    analysis: JSON.stringify(analysis)
  });
  if(history.length>120) history.shift();
  updateUI();
}

function updateUI(){
  const r = ready();
  view1Btn.disabled = !r;
  view2Btn.disabled = !r;
  analyzeBtn.disabled = !r || marks1.length===0 || marks2.length===0;

  undoBtn.disabled = history.length===0;
  clearBtn.disabled = curMarks().length===0;
  exportBtn.disabled = !r;
  savePngBtn.disabled = !(img1 || img2);
}

function fileToImg(f){
  return new Promise((resolve,reject)=>{
    const i = new Image();
    i.onload = ()=>resolve(i);
    i.onerror = reject;
    i.src = URL.createObjectURL(f);
  });
}

function fitCanvasToImage(image){
  const maxW = 1100;
  const sc = Math.min(1, maxW / image.naturalWidth);
  cv.width  = Math.round(image.naturalWidth * sc);
  cv.height = Math.round(image.naturalHeight * sc);
}

function canvasXY(ev){
  const r = cv.getBoundingClientRect();
  const x = (ev.clientX - r.left) * (cv.width / r.width);
  const y = (ev.clientY - r.top)  * (cv.height/ r.height);
  return {x,y};
}
function dist2(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return dx*dx+dy*dy; }
function nearestMark(x,y, px=26){
  const arr = curMarks();
  const p={x,y};
  const max2=px*px;
  let best=-1, bestD=1e18;
  for(let i=0;i<arr.length;i++){
    const d=dist2(arr[i],p);
    if(d<max2 && d<bestD){bestD=d;best=i;}
  }
  return best;
}

function redraw(){
  const img
