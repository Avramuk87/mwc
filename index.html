<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MWC — A1.7 (пины &gt;4 мм)</title>

<script async src="https://docs.opencv.org/4.x/opencv.js" type="text/javascript"></script>

<style>
body{font-family:-apple-system,system-ui,Arial;margin:16px}
h1{font-size:22px}
.card{border:1px solid #ddd;border-radius:14px;padding:14px;margin:14px 0}
button{width:100%;padding:14px;border-radius:12px;border:none;
background:#000;color:#fff;font-weight:700;font-size:16px}
button:disabled{opacity:.4}
canvas{max-width:100%;border-radius:12px;margin-top:12px}
.ok{color:#0a7;font-weight:700}
.bad{color:#c00;font-weight:700}
.small{color:#666;font-size:13px}
</style>
</head>

<body>

<h1>MWC — A1.7 (пины &gt;4 мм)</h1>
<p class="small">
Рамка 20×20 см ОБЯЗАТЕЛЬНО целиком в кадре. Фото строго сверху.
</p>

<div class="card">
<input type="file" id="file" accept="image/*">
<button id="analyze" disabled>АНАЛИЗ</button>
<p id="status" class="small">Загрузи фото</p>
</div>

<div class="card">
<canvas id="canvas"></canvas>
</div>

<div class="card">
<div id="result"></div>
</div>

<script>
let img = new Image();
let canvas = document.getElementById('canvas');
let ctx = canvas.getContext('2d');
let ready = false;

file.onchange = e => {
  const f = e.target.files[0];
  if(!f) return;
  img.onload = () => {
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img,0,0);
    analyze.disabled = false;
    status.textContent = "Фото загружено. Нажми «АНАЛИЗ»";
  };
  img.src = URL.createObjectURL(f);
};

function waitCV(){
  return new Promise(r=>{
    let t=setInterval(()=>{
      if(cv && cv.imread){clearInterval(t);r();}
    },200);
  });
}

analyze.onclick = async ()=>{
  analyze.disabled=true;
  status.textContent="Анализ...";
  await waitCV();

  let src = cv.imread(canvas);
  let gray = new cv.Mat();
  cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

  // --- ПОИСК РАМКИ ---
  let edges = new cv.Mat();
  cv.Canny(gray, edges, 80, 200);

  let contours = new cv.MatVector();
  let hier = new cv.Mat();
  cv.findContours(edges, contours, hier,
    cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

  let frame = null, maxArea=0;
  for(let i=0;i<contours.size();i++){
    let c = contours.get(i);
    let r = cv.boundingRect(c);
    let area = r.width*r.height;
    if(area>maxArea && r.width>200 && r.height>200){
      maxArea=area; frame=r;
    }
  }

  if(!frame){
    result.innerHTML="<span class='bad'>Рамка не найдена</span>";
    analyze.disabled=false; return;
  }

  let pxPerMM = frame.width / 200; // 20 см = 200 мм

  // --- ПОИСК ПИНОВ ---
  let blur = new cv.Mat();
  cv.GaussianBlur(gray, blur, new cv.Size(5,5),0);

  let bin = new cv.Mat();
  cv.adaptiveThreshold(
    blur, bin, 255,
    cv.ADAPTIVE_THRESH_GAUSSIAN_C,
    cv.THRESH_BINARY, 21, -5
  );

  let cnts = new cv.MatVector();
  cv.findContours(bin, cnts, hier,
    cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

  let count=0, sum=0;

  ctx.drawImage(img,0,0);

  for(let i=0;i<cnts.size();i++){
    let c = cnts.get(i);
    let area = cv.contourArea(c);
    if(area<20) continue;

    let peri = cv.arcLength(c,true);
    let circ = 4*Math.PI*area/(peri*peri);
    if(circ<0.65) continue;

    let dPx = Math.sqrt(4*area/Math.PI);
    let dMM = dPx / pxPerMM;

    if(dMM>=4 && dMM<=12){
      let m=cv.moments(c);
      let x=m.m10/m.m00;
      let y=m.m01/m.m00;
      ctx.strokeStyle="#00ff00";
      ctx.lineWidth=3;
      ctx.beginPath();
      ctx.arc(x,y,dPx/2,0,2*Math.PI);
      ctx.stroke();
      count++; sum+=dMM;
    }
  }

  result.innerHTML =
    "<div class='ok'>Пинов &gt;4 мм: "+count+
    "<br>Средний диаметр: "+
    (count? (sum/count).toFixed(1):"0")+" мм</div>";

  src.delete();gray.delete();edges.delete();
  blur.delete();bin.delete();
  analyze.disabled=false;
};
</script>

</body>
</html>
